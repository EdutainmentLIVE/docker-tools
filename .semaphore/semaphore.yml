version: v1.0
name: Default pipeline
agent:
  machine:
    type: e1-standard-2
  containers:
    - name: main
      image: semaphoreci/haskell:8.10.2
blocks:
  - name: Default block
    task:
      secrets:
        - name: docker-hub
      jobs:
        - name: Default job
          commands:
            - checkout
            - cache restore hackage
            - cabal update
            - cache store hackage ~/.cabal
            - cabal freeze
            - cat cabal.project.freeze
            - cache restore cabal-$( checksum cabal.project.freeze ),cabal
            - cabal build
            - cache store cabal-$( checksum cabal.project.freeze ) ~/.cabal/store

            - mkdir --parents output/bin output/lib

            - cabal install --installdir output/bin --install-method copy
              apply-refact
              brittany
              hasktags
              hlint
              stan
              weeder
            - strip output/bin/*

            - cp --recursive --target-directory output/lib
              /opt/ghc/8.10.2/lib/ghc-8.10.2/llvm-passes
              /opt/ghc/8.10.2/lib/ghc-8.10.2/llvm-targets
              /opt/ghc/8.10.2/lib/ghc-8.10.2/package.conf.d
              /opt/ghc/8.10.2/lib/ghc-8.10.2/platformConstants
              /opt/ghc/8.10.2/lib/ghc-8.10.2/settings

            - cp output/bin/brittany brittany/
            - cp --recursive output/lib brittany/ghc-lib
            - docker build --tag "itprotv/brittany:$SEMAPHORE_GIT_SHA" brittany
            - echo "$DOCKER_PASSWORD" | docker login --username "$DOCKER_USERNAME" --password-stdin
            - docker push "itprotv/brittany:$SEMAPHORE_GIT_SHA"

            - cp output/bin/hasktags hasktags/
            - docker build --tag "itprotv/hasktags:$SEMAPHORE_GIT_SHA" hasktags
            - echo "$DOCKER_PASSWORD" | docker login --username "$DOCKER_USERNAME" --password-stdin
            - docker push "itprotv/hasktags:$SEMAPHORE_GIT_SHA"

            - cp output/bin/hlint hlint/
            - cp output/bin/refactor hlint/
            - cp --recursive lib hlint/ghc-lib
            - docker build --tag "itprotv/hlint:$SEMAPHORE_GIT_SHA" hlint
            - echo "$DOCKER_PASSWORD" | docker login --username "$DOCKER_USERNAME" --password-stdin
            - docker push "itprotv/hlint:$SEMAPHORE_GIT_SHA"

            - cp output/bin/stan stan/
            - docker build --tag "itprotv/stan:$SEMAPHORE_GIT_SHA" stan
            - echo "$DOCKER_PASSWORD" | docker login --username "$DOCKER_USERNAME" --password-stdin
            - docker push "itprotv/stan:$SEMAPHORE_GIT_SHA"

            - cp output/bin/weeder weeder/
            - docker build --tag "itprotv/weeder:$SEMAPHORE_GIT_SHA" weeder
            - echo "$DOCKER_PASSWORD" | docker login --username "$DOCKER_USERNAME" --password-stdin
            - docker push "itprotv/weeder:$SEMAPHORE_GIT_SHA"
